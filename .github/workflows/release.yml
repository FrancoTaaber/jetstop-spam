name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Verify version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PLUGIN_VERSION=$(grep -m1 "Version:" jetstop-spam.php | sed 's/.*Version:[[:space:]]*//' | tr -d ' ')
          echo "Tag: $TAG_VERSION, Plugin: $PLUGIN_VERSION"
          [ "$TAG_VERSION" = "$PLUGIN_VERSION" ] || exit 1

      - name: Build
        run: chmod +x build.sh && ./build.sh

      - name: Checksums
        run: |
          cd build
          sha256sum jetstop-spam.zip > checksums.txt

      - uses: softprops/action-gh-release@v1
        with:
          name: Jetstop Spam ${{ github.ref_name }}
          body: |
            ## Jetstop Spam ${{ github.ref_name }}
            
            The most comprehensive anti-spam solution for WordPress.
            
            ### Installation
            1. Download `jetstop-spam.zip`
            2. WordPress Admin → Plugins → Add New → Upload
            3. Activate and configure at **Jetstop Spam**
          files: |
            build/jetstop-spam.zip
            build/checksums.txt
